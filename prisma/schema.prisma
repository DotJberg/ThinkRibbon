generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// ============================================
// User Model - Core user data synced with Clerk
// ============================================
model User {
  id          String   @id @default(cuid())
  clerkId     String   @unique
  email       String   @unique
  username    String   @unique
  displayName String?
  avatarUrl   String?
  bannerUrl   String?
  bio         String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  posts          Post[]
  articles       Article[]
  reviews        Review[]
  comments       Comment[]
  likes          Like[]
  followers      Follow[]        @relation("following")
  following      Follow[]        @relation("followers")
  articleDrafts  ArticleDraft[]
  reviewDrafts   ReviewDraft[]

  @@index([clerkId])
  @@index([username])
}

// ============================================
// Follow Model - User follow relationships
// ============================================
model Follow {
  id          String   @id @default(cuid())
  followerId  String
  followingId String
  createdAt   DateTime @default(now())
  
  follower  User @relation("followers", fields: [followerId], references: [id], onDelete: Cascade)
  following User @relation("following", fields: [followingId], references: [id], onDelete: Cascade)

  @@unique([followerId, followingId])
  @@index([followerId])
  @@index([followingId])
}

// ============================================
// Game Model - Cached game data from IGDB
// ============================================
model Game {
  id          String    @id @default(cuid())
  igdbId      Int       @unique
  name        String
  slug        String
  summary     String?   @db.Text
  coverUrl    String?
  releaseDate DateTime?
  genres      String[]
  platforms   String[]
  rating      Float?
  cachedAt    DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  reviews  Review[]
  articles ArticleGame[]

  @@index([igdbId])
  @@index([slug])
  @@index([name])
}

// ============================================
// Post Model - Short-form content (tweets)
// ============================================
model Post {
  id        String   @id @default(cuid())
  content   String   @db.VarChar(280)
  authorId  String
  author    User     @relation(fields: [authorId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  comments Comment[]
  likes    Like[]

  @@index([authorId])
  @@index([createdAt(sort: Desc)])
}

// ============================================
// Article Model - Long-form content
// ============================================
model Article {
  id               String   @id @default(cuid())
  title            String
  content          String   @db.Text
  contentJson      String?  @db.Text // TipTap JSON content
  excerpt          String?  @db.VarChar(500)
  coverImageUrl    String?
  coverFileKey     String?  // UploadThing file key for cleanup
  containsSpoilers Boolean  @default(false)
  published        Boolean  @default(false)
  authorId         String
  author           User     @relation(fields: [authorId], references: [id], onDelete: Cascade)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  games    ArticleGame[]
  images   ArticleImage[]
  comments Comment[]
  likes    Like[]

  @@index([authorId])
  @@index([published, createdAt(sort: Desc)])
}

// ============================================
// ArticleGame - Junction table for Article <-> Game
// ============================================
model ArticleGame {
  articleId String
  gameId    String
  article   Article @relation(fields: [articleId], references: [id], onDelete: Cascade)
  game      Game    @relation(fields: [gameId], references: [id], onDelete: Cascade)

  @@id([articleId, gameId])
}

// ============================================
// Review Model - Game reviews with ratings
// ============================================
model Review {
  id               String   @id @default(cuid())
  title            String
  content          String   @db.Text
  contentJson      String?  @db.Text // TipTap JSON content
  rating           Int
  coverImageUrl    String?
  coverFileKey     String?  // UploadThing file key for cleanup
  containsSpoilers Boolean  @default(false)
  published        Boolean  @default(false)
  authorId         String
  author           User     @relation(fields: [authorId], references: [id], onDelete: Cascade)
  gameId           String
  game             Game     @relation(fields: [gameId], references: [id], onDelete: Cascade)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  images   ReviewImage[]
  comments Comment[]
  likes    Like[]

  @@index([authorId, gameId])
  @@index([gameId])
  @@index([published, createdAt(sort: Desc)])
}

// ============================================
// Comment Model - Polymorphic comments
// ============================================
model Comment {
  id        String   @id @default(cuid())
  content   String   @db.VarChar(1000)
  authorId  String
  author    User     @relation(fields: [authorId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Polymorphic relation - only one should be set
  postId    String?
  articleId String?
  reviewId  String?
  post      Post?    @relation(fields: [postId], references: [id], onDelete: Cascade)
  article   Article? @relation(fields: [articleId], references: [id], onDelete: Cascade)
  review    Review?  @relation(fields: [reviewId], references: [id], onDelete: Cascade)

  likes     Like[]

  @@index([authorId])
  @@index([postId])
  @@index([articleId])
  @@index([reviewId])
  
  // Self-relation for nested comments
  parentId  String?
  parent    Comment?  @relation("CommentReplies", fields: [parentId], references: [id], onDelete: Cascade)
  replies   Comment[] @relation("CommentReplies")
  
  // Index for fetching replies efficiently
  @@index([parentId])
}

// ============================================
// Like Model - Polymorphic likes
// ============================================
model Like {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())

  // Polymorphic relation - only one should be set
  postId    String?
  articleId String?
  reviewId  String?
  commentId String?
  post      Post?    @relation(fields: [postId], references: [id], onDelete: Cascade)
  article   Article? @relation(fields: [articleId], references: [id], onDelete: Cascade)
  review    Review?  @relation(fields: [reviewId], references: [id], onDelete: Cascade)
  comment   Comment? @relation(fields: [commentId], references: [id], onDelete: Cascade)

  @@unique([userId, postId])
  @@unique([userId, articleId])
  @@unique([userId, reviewId])
  @@unique([userId, commentId])
  @@index([userId])
}

// ============================================
// ArticleImage - Track images in published articles
// ============================================
model ArticleImage {
  id        String  @id @default(cuid())
  url       String
  fileKey   String  // UploadThing file key for deletion
  caption   String? // Alt text / caption
  articleId String
  article   Article @relation(fields: [articleId], references: [id], onDelete: Cascade)

  @@index([articleId])
}

// ============================================
// ReviewImage - Track images in published reviews
// ============================================
model ReviewImage {
  id       String  @id @default(cuid())
  url      String
  fileKey  String  // UploadThing file key for deletion
  caption  String? // Alt text / caption
  reviewId String
  review   Review  @relation(fields: [reviewId], references: [id], onDelete: Cascade)

  @@index([reviewId])
}

// ============================================
// ArticleDraft - Draft articles (max 10 per user)
// ============================================
model ArticleDraft {
  id               String   @id @default(cuid())
  title            String?
  content          String?  @db.Text // TipTap JSON content
  excerpt          String?  @db.VarChar(500)
  coverImageUrl    String?
  coverFileKey     String?  // UploadThing file key for cleanup
  containsSpoilers Boolean  @default(false)
  gameIds          String[] // Store as array for drafts
  authorId         String
  author           User     @relation(fields: [authorId], references: [id], onDelete: Cascade)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  images ArticleDraftImage[]

  @@index([authorId, updatedAt(sort: Desc)])
}

// ============================================
// ArticleDraftImage - Track images in article drafts
// ============================================
model ArticleDraftImage {
  id      String       @id @default(cuid())
  url     String
  fileKey String       // UploadThing file key for deletion
  caption String?      // Alt text / caption
  draftId String
  draft   ArticleDraft @relation(fields: [draftId], references: [id], onDelete: Cascade)

  @@index([draftId])
}

// ============================================
// ReviewDraft - Draft reviews (max 10 per user)
// ============================================
model ReviewDraft {
  id               String   @id @default(cuid())
  title            String?
  content          String?  @db.Text // TipTap JSON content
  rating           Int?
  coverImageUrl    String?
  coverFileKey     String?  // UploadThing file key for cleanup
  containsSpoilers Boolean  @default(false)
  gameId           String?  // Game being reviewed
  authorId         String
  author           User     @relation(fields: [authorId], references: [id], onDelete: Cascade)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  images ReviewDraftImage[]

  @@index([authorId, updatedAt(sort: Desc)])
}

// ============================================
// ReviewDraftImage - Track images in review drafts
// ============================================
model ReviewDraftImage {
  id      String      @id @default(cuid())
  url     String
  fileKey String      // UploadThing file key for deletion
  caption String?     // Alt text / caption
  draftId String
  draft   ReviewDraft @relation(fields: [draftId], references: [id], onDelete: Cascade)

  @@index([draftId])
}
